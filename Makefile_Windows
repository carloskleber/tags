#MKLROOT is defined by a bash script that is shipped together with intel's MKL
#source mklvars.sh intel64
#manual set:
#"C:\Program Files (x86)\IntelSWTools\compilers_and_libraries_2019.1.144\windows\mkl\bin\mklvars.bat" intel64
MKLROOT = "C:\\Program Files (x86)\\IntelSWTools\\compilers_and_libraries_2019.1.144\\windows\\mkl"
INTELLINK = "C:\\Program Files (x86)\\IntelSWTools\\compilers_and_libraries_2019.1.144\\windows\\mkl\\lib\\intel64_win\\mkl_rt.lib"
INTELFLAGS = -DMKL_ILP64
#The shared library slatec is assumed to be in your path.
#If it is not, append its location to the INCLUDE variable or
#build and install it with "make slatec"

CUBATUREPATH = cubature
SLATECPATH = slatec
WOLFRAMPATH = "C:\\Program Files\\Wolfram Research\\Mathematica\\11.3\\SystemFiles\\IncludeFiles\\C"
INCLUDE = -Isrc -I$(CUBATUREPATH) -I$(MKLROOT)\\include -I$(SLATECPATH)\\lib -I$(MKLROOT)\\include
LINK = -L. $(INTELLINK) $(SLATECPATH)\\lib\\libslatec.a -lgfortran
CFLAGS = -Wall -fno-exceptions -std=c11 $(INTELFLAGS) -Werror -g
#CFLAGS = -Wall -std=c11 $(INTELFLAGS) -g
OBJECTS = electrode.o auxiliary.o hcubature.o

#Compilers
CC = gcc
FC = gfortran

.DEFAULT_GOAL := dynamicLibrary

.PHONY	:	clean cleanout allclean slatec libhem.so dynamicLibrary wolfram

clean	:
		rm -f *.o *.obj *.dat
		cd examples && rm -f *.o *.obj *.dat

cleanout	:
		rm -f *.a *.exe *.dll
		cd examples && rm -f *.a *.exe *.dll

cleanall	:
		make clean
		make cleanout
		cd $(SLATECPATH) && $(MAKE) clean
		cd $(CUBATUREPATH) && $(MAKE) clean

hcubature.o	:	$(CUBATUREPATH)\\hcubature.c
		$(CC) $(CFLAGS) -fPIC $(INCLUDE) -c $(CUBATUREPATH)\\hcubature.c $(LINK)

auxiliary.o	:	auxiliary.c
		$(CC) $(CFLAGS) -fPIC $(INCLUDE) -c auxiliary.c $(LINK)

electrode.o	:	electrode.c auxiliary.o hcubature.o
		$(CC) $(CFLAGS) -fPIC $(INCLUDE) -c electrode.c $(LINK)

dynamicLibrary	:
		$(CC) $(CFLAGS) -fPIC -shared $(INCLUDE) -o libhem.dll electrode.c auxiliary.c $(CUBATUREPATH)\\hcubature.c $(LINK)

test	:	$(OBJECTS)
		$(CC) $(CFLAGS) $(INCLUDE) -o testing.exe testing.c $(OBJECTS) $(LINK)

testDLL	:	libhem.dll
		$(CC) $(CFLAGS) $(INCLUDE) -o testingDLL.exe testing.c '-Wl,-rpath,$$ORIGIN' $(LINK) -lhem

slatec	:
		cd $(SLATECPATH) && $(MAKE) FC=$(FC) all

wolfram	:
		$(CC) -O3 -fPIC -shared -std=c11 $(INTELFLAGS) -Werror $(INCLUDE) -I$(WOLFRAMPATH) -o interfaces\\mathematica\\libhem_mma.dll interface_wolfram.c electrode.c auxiliary.c $(CUBATUREPATH)\\hcubature.c $(LINK)

timing	:	$(OBJECTS)
		$(CC) $(CFLAGS) $(INCLUDE) -o timing.exe examples\\timing.c $(OBJECTS) $(LINK)
# examples are named based on publication: author_volume_journal_issue
grcev20pwrd0	:	$(OBJECTS)
		$(CC) $(CFLAGS) $(INCLUDE) -o ex20pwrd02grcev.exe examples\\grcev20pwrd02.c $(OBJECTS) $(LINK)

grcev51emc03	:	$(OBJECTS)
		$(CC) $(CFLAGS) $(INCLUDE) -o ex51emc03grcev.exe examples\\grcev51emc03.c $(OBJECTS) $(LINK)

grcev12pwrd01	:	$(OBJECTS)
		$(CC) $(CFLAGS) $(INCLUDE) -o ex12pwrd01grcev.exe examples\\grcev12pwrd01.c $(OBJECTS) $(LINK)
